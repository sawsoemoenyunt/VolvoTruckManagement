@page "/"
@using VolvoTruckManagement.Model
@using VolvoTruckManagement.Services
@inject MudBlazor.IDialogService DialogService
@inject IServiceProvider ServiceProvider
@inject MudBlazor.ISnackbar Snackbar

<PageTitle>Trucks</PageTitle>
<MudBreadcrumbs Items="_breadCrumbitems"></MudBreadcrumbs>
<MudText Typo="Typo.h3" GutterBottom="true">Trucks</MudText>
@if (Trucks.Count > 0)
{

    <MudGrid AlignItems="Center" Class="mb-4">
        <!-- Search Field -->
        <MudItem xs="12" sm="6" md="4">
            <MudTextField T="string" 
                          Label="Search"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          AdornmentColor="Color.Dark"
                          Immediate="true"
                          ValueChanged="OnSearchChanged" Placeholder="Search by VIN, Brand or Build Year"/>
        </MudItem>

        <!-- Sort Dropdown -->
        <MudItem xs="12" sm="6" md="4">
            <div class="d-flex align-center gap-2">
                <MudSelect T="string"
                           Label="Sort By"
                           @bind-Value="sortField"
                           @bind-Value:event="onchange"
                           ValueChanged="OnSortChanged"
                           Variant="Variant.Outlined"
                           Class="flex-grow-1">
                    <MudSelectItem Value="@("TruckNumber")">Truck Number</MudSelectItem>
                    <MudSelectItem Value="@("Brand")">Brand</MudSelectItem>
                    <MudSelectItem Value="@("BuildDate")">Year</MudSelectItem>
                </MudSelect>

                <MudTooltip Text="Toggle sort order (ascending/descending)">
                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Small"
                               Color="Color.Transparent"
                               OnClick="ToggleSortOrder"
                               AriaLabel="Toggle sort order">
                        @if (sortAscending)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ArrowUpward" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" />
                        }
                    </MudButton>
                </MudTooltip>
            </div>
        </MudItem>



        <!-- Add New Truck Button -->
        <MudItem xs="12" sm="12" md="4" Class="d-flex justify-end">
            <MudButton @onclick="AddNewTruck" Variant="Variant.Filled" Color="Color.Dark" Class="align-self-center" Size="Size.Medium">
                Add New Truck
            </MudButton>
        </MudItem>
    </MudGrid>

}
<MudSpacer />
<MudDivider Class="mb-4 my-2" />

@if (Trucks == null || !Trucks.Any())

{

    <MudPaper Class="d-flex flex-column align-center justify-center p-6 mt-6" Elevation="2" Style="max-width: 500px; margin: auto; padding: 50px">
        <MudIcon Icon="@Icons.Material.Filled.DirectionsBusFilled" Size="Size.Large" Color="Color.Dark" Class="mb-2" />
        <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Dark" Class="mb-2">
            No trucks registered yet
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Primary" Class="mb-4">
            You can start by clicking the button below to add your first truck.
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Dark" OnClick="AddNewTruck">
            Add New Truck
        </MudButton>
    </MudPaper>
}
else
{
    <MudGrid>
        @foreach (var truck in pagedTrucks)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard Class="h-full shadow-md hover:shadow-lg transition-all">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">@truck.Brand</MudText>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary"> #@truck.TruckNumber</MudText>
                    </MudCardHeader>

                    <MudCardContent>
                        <MudText><b>VIN:</b> @truck.VIN</MudText>
                        <MudText><b>Build Year:</b> @truck.BuildDate</MudText>
                        @if (!string.IsNullOrWhiteSpace(truck.Comment))
                        {
                            <MudText Class="text-truncate" Style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                <b>Comment:</b> @truck.Comment
                            </MudText>

                        }
                    </MudCardContent>

                    <MudCardActions>
                        <MudButton Color="Color.Primary" Variant="Variant.Text" OnClick="@(() => ViewDetails(truck))">
                            View Details
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
        
    </MudGrid>
    <MudDivider Class="mb-4 my-2" />
    <MudPagination Color="Color.Primary" Count="@totalPages" SelectedChanged="PageChanged" />

}

@code {
    // Injected service for managing trucks (create, read, delete, etc.)
    private ITruckService TruckService;

    // Holds user input for the search/filter functionality
    public string Search { get; set; }

    private string sortField = "TruckNumber"; // default sort
    private bool sortAscending = true;        // default order

    // Breadcrumb navigation items for the page header
    private List<BreadcrumbItem> _breadCrumbitems = new()
    {
        new BreadcrumbItem("Dashboard", href: "/"),
        new BreadcrumbItem("Trucks", href: "/", disabled: true)
    };

    // Defines the spacing between grid elements (used by MudBlazor components)
    public int Spacing { get; set; } = 6;

    // The full list of trucks loaded from the service
    private List<Truck> Trucks = new();

    // Subset of trucks shown on the current page (for pagination)
    private List<Truck> pagedTrucks = new();

    // Current pagination page (1-based index)
    private int currentPage = 1;

    // Number of trucks to display per page
    private int pageSize = 6;

    // Dynamically calculated total number of pages
    private int totalPages;

    /// <summary>
    /// Called when the component is first initialized.
    /// Loads truck data and prepares the first page of results.
    /// </summary>
    protected override void OnInitialized()
    {
        // Get the truck service from the dependency injection container
        TruckService = ServiceProvider.GetRequiredService<ITruckService>();

        // Retrieve the full list of trucks
        Trucks = TruckService.GetTrucks();

        // Prepare the first page for display
        UpdatePagedTrucks();
    }

    private void ToggleSortOrder()
    {
        sortAscending = !sortAscending;
        currentPage = 1;
        UpdatePagedTrucks();
    }

    private void OnSortChanged(string value)
    {
        sortField = value;
        currentPage = 1;
        UpdatePagedTrucks();
    }

    private void OnSearchChanged(string value)
    {
        Search = value;
        currentPage = 1;
        UpdatePagedTrucks();
    }


    private void SortBy(string field)
    {
        if (sortField == field)
        {
            // If same field clicked again, toggle ascending/descending
            sortAscending = !sortAscending;
        }
        else
        {
            // Switch to a new field, reset ascending
            sortField = field;
            sortAscending = true;
        }

        currentPage = 1; // reset to first page
        UpdatePagedTrucks();
    }

    private string GetSortIcon(string field)
    {
        if (sortField != field) return "";
        return sortAscending ? Icons.Material.Filled.ArrowUpward : Icons.Material.Filled.ArrowDownward;
    }


    /// <summary>
    /// Handles pagination control changes.
    /// Updates the page number and refreshes the displayed list.
    /// </summary>
    private void PageChanged(int i)
    {
        currentPage = i;
        UpdatePagedTrucks();
    }

    /// <summary>
    /// Updates the currently displayed page of trucks based on pagination settings.
    /// </summary>
    private void UpdatePagedTrucks()
    {
        // Filter trucks first
        var filteredTrucks = Trucks
            .Where(t => string.IsNullOrWhiteSpace(Search)
                        || t.Brand.Contains(Search, StringComparison.OrdinalIgnoreCase)
                        || t.VIN.Contains(Search, StringComparison.OrdinalIgnoreCase)
                        || t.BuildDate.ToString().Contains(Search, StringComparison.OrdinalIgnoreCase)
                        || t.TruckNumber.ToString().Contains(Search))
            .ToList();

        // Sort based on field
        filteredTrucks = sortField switch
        {
            "TruckNumber" => sortAscending ? filteredTrucks.OrderBy(t => t.TruckNumber).ToList()
                                           : filteredTrucks.OrderByDescending(t => t.TruckNumber).ToList(),
            "Brand" => sortAscending ? filteredTrucks.OrderBy(t => t.Brand).ToList()
                                           : filteredTrucks.OrderByDescending(t => t.Brand).ToList(),
            "BuildDate" => sortAscending ? filteredTrucks.OrderBy(t => t.BuildDate).ToList()
                                           : filteredTrucks.OrderByDescending(t => t.BuildDate).ToList(),
            _ => filteredTrucks
        };

        // Apply pagination
        pagedTrucks = filteredTrucks
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

        totalPages = (int)Math.Ceiling((double)filteredTrucks.Count / pageSize);

        StateHasChanged();
    }


    /// <summary>
    /// Opens the Truck Detail dialog for viewing and managing an individual truck.
    /// </summary>
    /// <param name="truck">Truck object to view details for.</param>
    private async Task ViewDetails(Truck truck)
    {
        // Dialog configuration for size and layout
        DialogOptions _maxWidth = new() { MaxWidth = MaxWidth.Small, FullWidth = true, CloseOnEscapeKey = true, CloseButton = true };

        // Pass the selected truck to the detail dialog as a parameter
        var parameters = new DialogParameters<TruckDetailDialog>
        {
            { x => x.Truck, truck }
        };

        // Open the dialog
        var dialog = await DialogService.ShowAsync<TruckDetailDialog>("Truck Details", parameters, _maxWidth);

        // Await the result (e.g., close or update)
        var result = await dialog.Result;
    }

    /// <summary>
    /// Opens the Add Truck dialog for creating a new truck entry.
    /// After saving, updates the truck list and refreshes pagination.
    /// </summary>
    private async Task AddNewTruck()
    {
        // Check if we have reached the maximum truck number
        try
        {
            int nextTruckNumber = TruckService.GetNextAvailableUniqueTruckNumber();

            // Dialog configuration for size and layout
            DialogOptions _maxWidth = new() { MaxWidth = MaxWidth.Small, FullWidth = true, CloseOnEscapeKey = true, CloseButton = true };

            // Open the Add Truck dialog
            var dialog = await DialogService.ShowAsync<AddTruckDialog>("Add New Truck", _maxWidth);
            var result = await dialog.Result;

            // If the dialog wasn't canceled, refresh the list and UI
            if (!result.Canceled)
            {
                StateHasChanged();
                UpdatePagedTrucks();
            }
        }
        catch (InvalidOperationException ex)
        {
            // Show a user-friendly message using MudSnackbar
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }

}

