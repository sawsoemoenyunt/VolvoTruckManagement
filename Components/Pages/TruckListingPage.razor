@page "/"
@using VolvoTruckManagement.Model
@using VolvoTruckManagement.Services
@inject MudBlazor.IDialogService DialogService
@inject IServiceProvider ServiceProvider
@inject MudBlazor.ISnackbar Snackbar

<PageTitle>Trucks</PageTitle>
<MudBreadcrumbs Items="_breadCrumbitems"></MudBreadcrumbs>
<MudText Typo="Typo.h3" GutterBottom="true">Trucks</MudText>
@if (Trucks.Count > 0)
{

    <MudGrid>
        <MudItem xs="4">
            <MudTextField @bind-Value="Search" Label="Search" Variant="Variant.Outlined"
            Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
            AdornmentColor="Color.Dark" />
        </MudItem>
        <MudItem xs="2">
            <MudButton Variant="Variant.Outlined" Color="Color.Dark">
                <MudIcon Icon="@Icons.Material.Filled.FilterList" />
                Filter
            </MudButton>
        </MudItem>
        <MudItem xs="6" Class="d-flex justify-end">
            <MudButton @onclick="AddNewTruck" Variant="Variant.Filled" Color="Color.Dark" Class="align-self-center" Size="Size.Large">
                Add New Truck
            </MudButton>
        </MudItem>
    </MudGrid>
}
<MudSpacer />
<MudDivider Class="mb-4 my-2" />

@if (Trucks == null || !Trucks.Any())

{

    <MudPaper Class="d-flex flex-column align-center justify-center p-6 mt-6" Elevation="2" Style="max-width: 500px; margin: auto; padding: 50px">
        <MudIcon Icon="@Icons.Material.Filled.DirectionsBusFilled" Size="Size.Large" Color="Color.Dark" Class="mb-2" />
        <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Dark" Class="mb-2">
            No trucks registered yet
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Primary" Class="mb-4">
            You can start by clicking the button below to add your first truck.
        </MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Dark" OnClick="AddNewTruck">
            Add New Truck
        </MudButton>
    </MudPaper>


}
else
{
    <MudGrid>
        @foreach (var truck in pagedTrucks)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard Class="h-full shadow-md hover:shadow-lg transition-all">
                    <MudCardHeader>
                        <MudText Typo="Typo.h6">@truck.Brand</MudText>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary"> #@truck.TruckNumber</MudText>
                    </MudCardHeader>

                    <MudCardContent>
                        <MudText><b>VIN:</b> @truck.VIN</MudText>
                        <MudText><b>Build Year:</b> @truck.BuildDate</MudText>
                        @if (!string.IsNullOrWhiteSpace(truck.Comment))
                        {
                            <MudText Class="text-truncate" Style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                <b>Comment:</b> @truck.Comment
                            </MudText>

                        }
                    </MudCardContent>

                    <MudCardActions>
                        <MudButton Color="Color.Primary" Variant="Variant.Text" OnClick="@(() => ViewDetails(truck))">
                            View Details
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
        
    </MudGrid>
    <MudDivider Class="mb-4 my-2" />
    <MudPagination Color="Color.Primary" Count="@totalPages" SelectedChanged="PageChanged" />

}

@code {
    // Injected service for managing trucks (create, read, delete, etc.)
    private ITruckService TruckService;

    // Holds user input for the search/filter functionality
    public string Search { get; set; }

    // Breadcrumb navigation items for the page header
    private List<BreadcrumbItem> _breadCrumbitems = new()
    {
        new BreadcrumbItem("Dashboard", href: "/"),
        new BreadcrumbItem("Trucks", href: "/", disabled: true)
    };

    // Defines the spacing between grid elements (used by MudBlazor components)
    public int Spacing { get; set; } = 6;

    // The full list of trucks loaded from the service
    private List<Truck> Trucks = new();

    // Subset of trucks shown on the current page (for pagination)
    private List<Truck> pagedTrucks = new();

    // Current pagination page (1-based index)
    private int currentPage = 1;

    // Number of trucks to display per page
    private int pageSize = 6;

    // Dynamically calculated total number of pages
    private int totalPages => (int)Math.Ceiling((double)Trucks.Count / pageSize);

    /// <summary>
    /// Called when the component is first initialized.
    /// Loads truck data and prepares the first page of results.
    /// </summary>
    protected override void OnInitialized()
    {
        // Get the truck service from the dependency injection container
        TruckService = ServiceProvider.GetRequiredService<ITruckService>();

        // Retrieve the full list of trucks
        Trucks = TruckService.GetTrucks();

        // Prepare the first page for display
        UpdatePagedTrucks();
    }

    /// <summary>
    /// Handles pagination control changes.
    /// Updates the page number and refreshes the displayed list.
    /// </summary>
    private void PageChanged(int i)
    {
        currentPage = i;
        UpdatePagedTrucks();
    }

    /// <summary>
    /// Updates the currently displayed page of trucks based on pagination settings.
    /// </summary>
    private void UpdatePagedTrucks()
    {
        // Skip records from previous pages and take only those for the current page
        pagedTrucks = Trucks
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

        // Re-render the component to reflect updated data
        StateHasChanged();
    }

    /// <summary>
    /// Opens the Truck Detail dialog for viewing and managing an individual truck.
    /// </summary>
    /// <param name="truck">Truck object to view details for.</param>
    private async Task ViewDetails(Truck truck)
    {
        // Dialog configuration for size and layout
        DialogOptions _maxWidth = new() { MaxWidth = MaxWidth.Small, FullWidth = true, CloseOnEscapeKey = true, CloseButton = true };

        // Pass the selected truck to the detail dialog as a parameter
        var parameters = new DialogParameters<TruckDetailDialog>
        {
            { x => x.Truck, truck }
        };

        // Open the dialog
        var dialog = await DialogService.ShowAsync<TruckDetailDialog>("Truck Details", parameters, _maxWidth);

        // Await the result (e.g., close or update)
        var result = await dialog.Result;
    }

    /// <summary>
    /// Opens the Add Truck dialog for creating a new truck entry.
    /// After saving, updates the truck list and refreshes pagination.
    /// </summary>
    private async Task AddNewTruck()
    {
        // Check if we have reached the maximum truck number
        try
        {
            int nextTruckNumber = TruckService.GetNextAvailableUniqueTruckNumber();

            // Dialog configuration for size and layout
            DialogOptions _maxWidth = new() { MaxWidth = MaxWidth.Small, FullWidth = true, CloseOnEscapeKey = true, CloseButton = true };

            // Open the Add Truck dialog
            var dialog = await DialogService.ShowAsync<AddTruckDialog>("Add New Truck", _maxWidth);
            var result = await dialog.Result;

            // If the dialog wasn't canceled, refresh the list and UI
            if (!result.Canceled)
            {
                StateHasChanged();
                UpdatePagedTrucks();
            }
        }
        catch (InvalidOperationException ex)
        {
            // Show a user-friendly message using MudSnackbar
            Snackbar.Add(ex.Message, Severity.Warning);
        }
    }

}

